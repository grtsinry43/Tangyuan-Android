name: Nightly Build

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build Nightly APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Get commit hash
        id: commit
        run: echo "SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/Tangyuan-nightly-${{ steps.date.outputs.DATE }}-${{ steps.commit.outputs.SHA }}.apk

      - name: Delete old nightly releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 7
          delete_tag_pattern: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create/Update Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ steps.date.outputs.DATE }}
          name: Nightly Build ${{ steps.date.outputs.DATE }}
          body: |
            ## ğŸŒ™ Nightly Build

            **æ„å»ºæ—¥æœŸ**: ${{ steps.date.outputs.DATE }}
            **æäº¤**: ${{ steps.commit.outputs.SHA }}

            è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„æ¯æ—¥æµ‹è¯•ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„æ–°åŠŸèƒ½å’Œå®éªŒæ€§æ›´æ”¹ã€‚

            âš ï¸ **è­¦å‘Š**: Nightly ç‰ˆæœ¬ä»…ä¾›æµ‹è¯•ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚
          files: app/build/outputs/apk/debug/Tangyuan-nightly-${{ steps.date.outputs.DATE }}-${{ steps.commit.outputs.SHA }}.apk
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tangyuan-nightly-${{ steps.date.outputs.DATE }}
          path: app/build/outputs/apk/debug/Tangyuan-nightly-${{ steps.date.outputs.DATE }}-${{ steps.commit.outputs.SHA }}.apk
          retention-days: 30