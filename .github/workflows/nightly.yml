name: Nightly Build

on:
  schedule:
    # 每天 UTC 时间 00:00 执行（北京时间 08:00）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    name: Build Nightly APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Get commit hash
        id: commit
        run: echo "SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/Tangyuan-nightly-${{ steps.date.outputs.DATE }}-${{ steps.commit.outputs.SHA }}.apk

      - name: Delete old nightly releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 7
          delete_tag_pattern: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create/Update Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ steps.date.outputs.DATE }}
          name: Nightly Build ${{ steps.date.outputs.DATE }}
          body: |
            ## 🌙 Nightly Build

            **构建日期**: ${{ steps.date.outputs.DATE }}
            **提交**: ${{ steps.commit.outputs.SHA }}

            这是自动构建的每日测试版本，可能包含未经充分测试的新功能和实验性更改。

            ⚠️ **警告**: Nightly 版本仅供测试使用，不建议在生产环境中使用。
          files: app/build/outputs/apk/debug/Tangyuan-nightly-${{ steps.date.outputs.DATE }}-${{ steps.commit.outputs.SHA }}.apk
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tangyuan-nightly-${{ steps.date.outputs.DATE }}
          path: app/build/outputs/apk/debug/Tangyuan-nightly-${{ steps.date.outputs.DATE }}-${{ steps.commit.outputs.SHA }}.apk
          retention-days: 30